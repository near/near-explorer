name: Run Tests
on:
  pull_request:
  push:
    branches:
      - master

jobs:
  codestyle:
    name: Code Style
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-18.04]
        node: [16]
    steps:
      - uses: actions/checkout@v1
      - name: Install packages
        run: npm install
      - name: Run code formatting check
        run: npm run fmt:check

  frontend-test:
    name: Frontend unit testing
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-18.04]
        node: [16]
    steps:
      - uses: actions/checkout@v1
      - name: Install packages
        run: npm install
      - name: Run unit tests
        run: npm run -w frontend test

  frontend-e2e-test:
    name: Frontend e2e testing
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-18.04]
        node: [16]
    steps:
      - uses: actions/checkout@v1
      - name: Install packages
        run: npm install
      - name: Build Project
        run: npm run -w frontend build
      - name: Run Cypress
        run: npm run -w frontend test:ci
        env:
          CYPRESS_DASHBOARD_KEY: ${{ secrets.CYPRESS_DASHBOARD_KEY }}

  backend-typecheck:
    name: Backend typecheck
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-18.04]
        node: [16]
    steps:
      - uses: actions/checkout@v1
      - name: Install packages
        run: npm install
      - name: Run typecheck
        run: npm run -w backend typecheck

  backend-database-types-check:
    name: Backend database types check
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-18.04]
        node: [16]
    steps:
      - uses: actions/checkout@v1
      - name: Install packages
        run: npm install
      - name: Copy original models
        run: cp -r backend/src/database/models backend/src/database/models-original
      - name: Generate types
        run: npm run -w backend db:generate-types
      - name: Run prettier on newly generated types
        run: npm run fmt
      - name: Compare types
        run: diff -bur backend/src/database/models-original backend/src/database/models
